# ==============================================================================
# Pipeline Configuration — {{PROJECT_NAME}}
# ==============================================================================

project:
  name: "{{PROJECT_NAME}}"
  description: "{{PROJECT_DESCRIPTION}}"
  root: "."

# Steps della pipeline — ogni feature attraversa questi step in ordine
steps:
  - name: pm
    display: "PM"
    model: "{{PM_MODEL}}"
    prompt_section: "PROMPT PM (Sessione 1 di ogni feature)"
    output_check: "docs/specs/{{FEATURE}}.md"
    commit_message: "docs(specs): add {{FEATURE}} specification"

  - name: dr_spec
    display: "DR-SPEC"
    model: "{{DR_SPEC_MODEL}}"
    prompt_section: "PROMPT DR-SPEC"
    output_check: "docs/design-review/{{FEATURE}}-spec.md"
    result_patterns:
      pass: "APPROVATA|PASS"
      fail: "REVISIONI RICHIESTE|FAIL"
    retry_with: pm
    max_retries: 2
    commit_message: "docs(design-review): add {{FEATURE}} spec review"

  - name: dev
    display: "DEV"
    model: "{{DEV_MODEL}}"
    prompt_section: "PROMPT DEV (Sessione 3 di ogni feature)"
    post_hooks:
      - smoke_test
    commit_message: "feat({{FEATURE}}): implement {{FEATURE}}"

  - name: seed
    display: "SEED"
    type: script
    script: "scripts/seed/{{FEATURE}}.ts"
    runner: "npx tsx"
    optional: true
    commit_message: "chore(seed): add {{FEATURE}} seed data"

  - name: dr_impl
    display: "DR-IMPL"
    model: "{{DR_IMPL_MODEL}}"
    prompt_section: "PROMPT DR-IMPL"
    output_check: "docs/design-review/{{FEATURE}}-impl.md"
    result_patterns:
      pass: "APPROVATA|PASS"
      fail: "REVISIONI RICHIESTE|FAIL"
    retry_with: dev
    max_retries: 2
    requires_dev_server: true
    commit_message: "docs(design-review): add {{FEATURE}} impl review"

  - name: qa
    display: "QA"
    model: "{{QA_MODEL}}"
    prompt_section: "PROMPT QA (Sessione 5 di ogni feature)"
    output_check: "docs/qa/{{FEATURE}}-qa.md"
    result_patterns:
      pass: "PASS"
      fail: "FAIL"
    retry_with: dev_fix
    max_retries: 2
    requires_dev_server: true
    commit_message: "docs(qa): add {{FEATURE}} QA report"

# Dev-fix step (usato internamente dai retry)
dev_fix:
  model: "{{DEV_FIX_MODEL}}"
  prompt_section: "PROMPT DEV-FIX"
  commit_message: "fix({{FEATURE}}): resolve QA issues"

# Dev server configuration
dev_server:
  command: "{{DEV_SERVER_COMMAND}}"
  working_dir: "{{DEV_SERVER_WORKING_DIR}}"
  port: {{DEV_SERVER_PORT}}
  health_check_url: "{{DEV_SERVER_HEALTH_CHECK}}"
  startup_timeout_seconds: {{DEV_SERVER_STARTUP_TIMEOUT}}

# Smoke test configuration
smoke_test:
  default_pages:
    - "/"
  error_patterns:
    - "an error has occurred"
    - "is not defined"
    - "Internal Server Error"
    - "Cannot read properties"
    - "TypeError"
    - "ReferenceError"
    - "SyntaxError"

# Claude Code CLI configuration
claude:
  allowed_tools: "Read,Write,Edit,Bash,Glob,Grep,NotebookEdit,WebFetch,mcp__*"
  output_format: stream-json
  verbose: true
  max_turns: 50

# Meta-logging
meta_logging:
  enabled: true
  dir: "logs/meta"
  decision_log: "logs/decisions.jsonl"

# Supervisor configuration
supervisor:
  enabled: false
  poll_interval_seconds: 30
  max_restarts: 3
  stall_timeout_minutes: 30
  backoff_minutes: [5, 10, 20, 40, 60]
  telegram:
    bot_token: "{{TELEGRAM_BOT_TOKEN}}"
    chat_id: "{{TELEGRAM_CHAT_ID}}"
  # Set PIPELINE_PROJECT_NAME env var to identify this project in Telegram messages
  # e.g. export PIPELINE_PROJECT_NAME="MyProject" or add to .env

# Exit code conventions
exit_codes:
  success: 0
  business_error: 1
  token_exhausted: 75
  tool_failure: 76
  fatal: 99

# Features da implementare (compilare con le feature del progetto)
features: []
  # - name: contacts
  #   phase: 1
  #   description: "CRUD contatti, lista, dettaglio, form"
  #   smoke_test_pages: ["/", "/contacts"]
